# Copyright 2024 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Defines a WORKSPACE rule for generating SDK companion image targets."""

load("@fuchsia_infra//cipd:defs.bzl", "cipd_repository")

def _fuchsia_products_repository_impl(ctx):
    product_bundles_metadata = json.decode(ctx.read(ctx.attr.product_bundles_manifest))
    ctx.file("BUILD.bazel", """# DO NOT MODIFY.
# AUTOGENERATED BY `fuchsia_products_repository.bzl`.

load("@fuchsia_sdk//fuchsia:defs.bzl", "fuchsia_remote_product_bundle")

""" + "\n\n".join([
        """
fuchsia_remote_product_bundle(
    name = "%s",
    transfer_url = "%s",
    product_version = "%s",
    visibility = ["//visibility:public"],
)
""".strip() % (pb["name"], pb["transfer_manifest_url"], pb["product_version"])
        for pb in product_bundles_metadata
    ]))

_fuchsia_products_repository = repository_rule(
    doc = """Initalizes targets for SDK companion images.

Example Usage:
```
# Initializing the repo:
load("@fuchsia_sdk//fuchsia:deps.bzl", "fuchsia_products_repository")

fuchsia_products_repository(
    name = "fuchsia_products",
    cipd_bin = "@cipd_tool//:cipd",
    ensure_file = "//manifests:product_bundles.ensure",
)

# Examining the generated targest:
#   $ bazel query '@fuchsia_products//... except attr("tags", "manual", @fuchsia_products//...)'

# Using the targets:
#   $ bazel run @fuchsia_products//:core.x64.emu -- --headless
#   $ bazel run @fuchsia_products//:core.vim3.flash
""",
    implementation = _fuchsia_products_repository_impl,
    attrs = {
        "product_bundles_manifest": attr.label(
            doc = "A label referencing product_bundles.json.",
            allow_single_file = True,
            mandatory = True,
        ),
    },
)

def fuchsia_products_repository(
        *,
        name,
        cipd_bin = None,
        ensure_file = None,
        **kwargs):
    product_metadata_repo = "%s_metadata" % name
    cipd_repository(
        name = product_metadata_repo,
        cipd_bin = cipd_bin,
        ensure_file = ensure_file,
        build_file_content = "exports_files(glob(['**/*']))",
    )

    _fuchsia_products_repository(
        name = name,
        product_bundles_manifest = "@%s//:product_bundles.json" % product_metadata_repo,
        **kwargs
    )
